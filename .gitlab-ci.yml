test:
  stage: test
  image: gradle:6.8.3-jdk8
  before_script:
    - export GRADLE_USER_HOME=`pwd`/.gradle
  script:
    - gradle build
  except:
    - tags
  cache:
    paths:
      - .gradle/wrapper
      - .gradle/caches
  only:
    - merge_requests


publish-with-gradle:
  stage: deploy
  image: registry.gitlab.com/halodi/tooling/gitlab-ci-cd/dockers/vault-and-gradle:0.0.1-vault1.7.1-gradle6.8.3-jdk8
  script:
    - gradle jar
    - ARTIFACT_VERSION=$CI_COMMIT_TAG gradle publish -p .
  only:
    - /^((\d+)\.(\d+)\.(\d+))((-)(\balpha\b)|(-)(\bbeta\b)|(-)(\bhalodi\b))?(\.\d+)?$/

composition:
  variables:
    UPSTREAM_PROJECT: $CI_PROJECT_NAME
    UPSTREAM_BRANCH: $CI_COMMIT_REF_NAME
    UPSTREAM_SHA: $CI_COMMIT_SHA
  stage: .post
  trigger: 
    project: halodi/controls/composition/ros2-composition
    branch: main
    strategy: depend
  needs: ["test"]
  only:
    - merge_requests